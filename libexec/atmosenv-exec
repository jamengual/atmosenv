#!/usr/bin/env bash
# atmosenv-exec - Execute atmos with the selected version

set -eo pipefail

# Source libraries
# shellcheck source=lib/bashlog.sh
source "${ATMOSENV_ROOT}/lib/bashlog.sh"
# shellcheck source=lib/helpers.sh
source "${ATMOSENV_ROOT}/lib/helpers.sh"
# shellcheck source=lib/atmosenv-version-file.sh
source "${ATMOSENV_ROOT}/lib/atmosenv-version-file.sh"

# Get the current version to use
get_version() {
  local version=""

  # 1. Check environment variable (highest priority)
  if [[ -n "${ATMOSENV_ATMOS_VERSION:-}" ]]; then
    version="${ATMOSENV_ATMOS_VERSION}"
    log_debug "Using version from ATMOSENV_ATMOS_VERSION: ${version}"
  fi

  # 2. Check version file
  if [[ -z "${version}" ]]; then
    local version_file
    version_file="$(get_version_file)"

    if [[ -f "${version_file}" ]]; then
      version="$(read_version_file "${version_file}")" || true
      log_debug "Using version from ${version_file}: ${version}"
    fi
  fi

  # 3. Fallback to latest installed
  if [[ -z "${version}" ]]; then
    local versions_dir="${ATMOSENV_CONFIG_DIR}/versions"
    if [[ -d "${versions_dir}" ]]; then
      version="$(find "${versions_dir}" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; 2>/dev/null | \
        sort -t. -k1,1nr -k2,2nr -k3,3nr | head -n1)" || true
      log_debug "Using latest installed version: ${version}"
    fi
  fi

  clean_version "${version}"
}

main() {
  local version
  version="$(get_version)"

  if [[ -z "${version}" ]]; then
    abort "No Atmos version selected. Run 'atmosenv install' first."
  fi

  local binary="${ATMOSENV_CONFIG_DIR}/versions/${version}/atmos"
  local os
  os="$(detect_os)"
  local ext
  ext="$(get_binary_extension "${os}")"

  # Add extension for Windows
  if [[ -n "${ext}" ]]; then
    binary="${binary}${ext}"
  fi

  # Check if version is installed
  if [[ ! -f "${binary}" ]]; then
    if [[ "${ATMOSENV_AUTO_INSTALL}" == "true" ]]; then
      log_info "Version ${version} not installed. Auto-installing..."
      "${ATMOSENV_ROOT}/libexec/atmosenv-install" "${version}"
    else
      abort "Atmos ${version} is not installed. Run 'atmosenv install ${version}' first."
    fi
  fi

  # Verify binary is executable
  if [[ ! -x "${binary}" ]]; then
    abort "Atmos binary is not executable: ${binary}"
  fi

  log_debug "Executing: ${binary} $*"

  # Execute atmos with all arguments
  exec "${binary}" "$@"
}

main "$@"
