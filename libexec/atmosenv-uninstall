#!/usr/bin/env bash
# atmosenv-uninstall - Uninstall a specific Atmos version

set -eo pipefail

# Source libraries
# shellcheck source=libexec/bashlog.sh
source "${ATMOSENV_ROOT}/libexec/bashlog.sh"
# shellcheck source=libexec/helpers.sh
source "${ATMOSENV_ROOT}/libexec/helpers.sh"

usage() {
  cat <<EOF
Usage: atmosenv uninstall [OPTIONS] VERSION

Uninstall a specific Atmos version.

Arguments:
   VERSION     Version to uninstall (e.g., 1.201.0)

Options:
   -f, --force  Don't ask for confirmation
   -h, --help   Show this help message

Examples:
   atmosenv uninstall 1.201.0    Uninstall version 1.201.0
   atmosenv uninstall -f 1.200.0 Uninstall without confirmation
EOF
}

main() {
  local version=""
  local force=false

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "${1}" in
      -h|--help)
        usage
        exit 0
        ;;
      -f|--force)
        force=true
        ;;
      -*)
        abort "Unknown option: ${1}"
        ;;
      *)
        if [[ -n "${version}" ]]; then
          abort "Multiple versions specified. Only one version can be uninstalled at a time."
        fi
        version="${1}"
        ;;
    esac
    shift
  done

  if [[ -z "${version}" ]]; then
    abort "No version specified. Usage: atmosenv uninstall VERSION"
  fi

  # Clean version
  version="$(clean_version "${version}")"

  # Validate version doesn't contain special keywords
  case "${version}" in
    latest|min-required|latest-allowed)
      abort "Cannot uninstall '${version}'. Please specify an exact version number."
      ;;
  esac

  local version_dir="${ATMOSENV_CONFIG_DIR}/versions/${version}"

  # Check if version is installed
  if [[ ! -d "${version_dir}" ]]; then
    abort "Atmos ${version} is not installed"
  fi

  # Read default version BEFORE deletion to avoid race condition
  local default_version_file="${ATMOSENV_CONFIG_DIR}/version"
  local default_version=""
  if [[ -f "${default_version_file}" ]]; then
    default_version="$(cat "${default_version_file}")"
  fi

  # Confirm unless forced
  if [[ "${force}" != "true" ]]; then
    log_warn "This will remove Atmos ${version} from ${version_dir}"
    read -r -p "Are you sure? [y/N] " confirm
    case "${confirm}" in
      [yY][eE][sS]|[yY])
        ;;
      *)
        log_info "Aborted"
        exit 0
        ;;
    esac
  fi

  # Remove version directory
  rm -rf "${version_dir}"

  # Try to clean up empty versions directory
  rmdir "${ATMOSENV_CONFIG_DIR}/versions" 2>/dev/null || true

  log_info "Uninstalled Atmos ${version}"

  # Warn if this was the default version
  if [[ "${default_version}" == "${version}" ]]; then
    log_warn "Note: ${version} was your default version"
    log_info "Run 'atmosenv use <version>' to set a new default"
  fi
}

main "$@"
